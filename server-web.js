const express = require('express');
const path = require('path');
const cors = require('cors');
const bodyParser = require('body-parser');
const moment = require('moment');
const nodemailer = require('nodemailer');
const { createServer } = require('http');
const { Server } = require('socket.io');
const { createClient } = require('@supabase/supabase-js');

const app = express();
const server = createServer(app);
const io = new Server(server, {
    cors: {
        origin: "*",
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"],
        credentials: true
    },
    transports: ['websocket', 'polling'],
    allowEIO3: true
});

const PORT = process.env.PORT || 3000;

// Middleware
app.use(cors({
    origin: "*",
    credentials: true
}));
app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ extended: true, limit: '10mb' }));

// Servir arquivos est√°ticos da pasta public
app.use(express.static(path.join(__dirname, 'public')));

// Configura√ß√£o do Supabase (gratuito)
const SUPABASE_URL = process.env.SUPABASE_URL || 'https://your-project.supabase.co';
const SUPABASE_KEY = process.env.SUPABASE_ANON_KEY || 'your-anon-key';

let supabase = null;
let contas = [];
let nextId = 1;
let isConnected = false;

// Fun√ß√£o para conectar ao Supabase
async function conectarSupabase() {
    try {
        console.log('üîÑ Conectando ao Supabase...');
        console.log('üîó URL:', SUPABASE_URL);
        console.log('üîë Key configurada:', SUPABASE_KEY !== 'your-anon-key' ? '‚úÖ Sim' : '‚ùå N√£o');
        
        if (SUPABASE_URL === 'https://your-project.supabase.co' || SUPABASE_KEY === 'your-anon-key') {
            console.log('‚ö†Ô∏è Supabase n√£o configurado, usando armazenamento local...');
            await carregarDadosLocal();
            return;
        }
        
        supabase = createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: false
            }
        });
        
        // Testar conex√£o
        const { data, error } = await supabase
            .from('contas')
            .select('count')
            .limit(1);
            
        if (error) {
            throw error;
        }
        
        console.log('‚úÖ Conectado ao Supabase com sucesso');
        isConnected = true;
        
        // Carregar dados iniciais
        await carregarDados();
        
        // Configurar listener para mudan√ßas em tempo real
        const subscription = supabase
            .channel('contas_changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'contas' }, (payload) => {
                console.log('üîÑ Mudan√ßa detectada no banco:', payload);
                io.emit('contas_updated', { action: payload.eventType, data: payload.new || payload.old });
            })
            .subscribe();
            
    } catch (error) {
        console.log('‚ùå Erro ao conectar ao Supabase:', error.message);
        console.log('üîç Stack trace:', error.stack);
        console.log('üîÑ Usando armazenamento local...');
        isConnected = false;
        await carregarDadosLocal();
    }
}

// Fun√ß√£o para carregar dados do Supabase
async function carregarDados() {
    try {
        console.log('üîÑ Carregando dados do Supabase...');
        
        if (!supabase || !isConnected) {
            console.log('‚ùå Conex√£o com Supabase n√£o dispon√≠vel');
            return;
        }
        
        // Buscar todas as contas
        const { data: contasDB, error } = await supabase
            .from('contas')
            .select('*')
            .order('id', { ascending: true });
            
        if (error) {
            throw error;
        }
        
        contas = contasDB || [];
        
        // Buscar o pr√≥ximo ID
        const { data: config } = await supabase
            .from('config')
            .select('value')
            .eq('key', 'nextId')
            .single();
            
        nextId = config ? config.value : (contas.length > 0 ? Math.max(...contas.map(c => c.id)) + 1 : 1);
        
        console.log('‚úÖ Dados carregados do Supabase:', contas.length, 'contas');
        console.log('üÜî Pr√≥ximo ID:', nextId);
        
        // Log detalhado das contas
        if (contas.length > 0) {
            console.log('üìã Detalhes das contas:');
            contas.forEach((conta, index) => {
                console.log(`  ${index + 1}. ID: ${conta.id}, Descri√ß√£o: ${conta.descricao}, Tipo: ${conta.tipo}, Paga: ${conta.paga}`);
            });
        }
        
    } catch (error) {
        console.log('‚ùå Erro ao carregar dados do Supabase:', error.message);
        console.log('üîç Stack trace:', error.stack);
        contas = [];
        nextId = 1;
    }
}

// Fun√ß√£o para salvar dados no Supabase
async function salvarDados() {
    try {
        console.log('üíæ Salvando dados no Supabase...');
        console.log('üìä Total de contas para salvar:', contas.length);
        console.log('üÜî Pr√≥ximo ID:', nextId);
        
        if (!supabase || !isConnected) {
            console.log('‚ùå Conex√£o com Supabase n√£o dispon√≠vel');
            return;
        }
        
        // Atualizar pr√≥ximo ID
        const { error } = await supabase
            .from('config')
            .upsert({ key: 'nextId', value: nextId });
            
        if (error) {
            throw error;
        }
        
        console.log('‚úÖ Dados salvos no Supabase com sucesso');
        console.log('üìÖ √öltima atualiza√ß√£o:', new Date().toISOString());
        
    } catch (error) {
        console.log('‚ùå Erro ao salvar dados no Supabase:', error.message);
        console.log('üîç Stack trace:', error.stack);
    }
}

// Fun√ß√£o para carregar dados de arquivo local (fallback)
async function carregarDadosLocal() {
    try {
        console.log('üîÑ Carregando dados do arquivo local...');
        const fs = require('fs-extra');
        const DATA_FILE = path.join(__dirname, 'database', 'contas.json');
        
        // Criar pasta database se n√£o existir
        await fs.ensureDir(path.dirname(DATA_FILE));
        
        // Verificar se o arquivo existe
        if (await fs.pathExists(DATA_FILE)) {
            console.log('üìÑ Arquivo de dados encontrado, lendo...');
            const dados = await fs.readJson(DATA_FILE);
            contas = dados.contas || [];
            nextId = dados.nextId || 1;
            console.log('‚úÖ Dados carregados do arquivo:', contas.length, 'contas');
        } else {
            console.log('üìÅ Arquivo de dados n√£o encontrado, iniciando com dados vazios');
            contas = [];
            nextId = 1;
        }
    } catch (error) {
        console.log('‚ùå Erro ao carregar dados do arquivo:', error.message);
        contas = [];
        nextId = 1;
    }
}

// Fun√ß√£o para salvar dados em arquivo local (fallback)
async function salvarDadosLocal() {
    try {
        console.log('üíæ Salvando dados no arquivo local...');
        const fs = require('fs-extra');
        const DATA_FILE = path.join(__dirname, 'database', 'contas.json');
        
        await fs.ensureDir(path.dirname(DATA_FILE));
        
        const dadosParaSalvar = {
            contas: contas,
            nextId: nextId,
            ultimaAtualizacao: new Date().toISOString()
        };
        
        await fs.writeJson(DATA_FILE, dadosParaSalvar, { spaces: 2 });
        console.log('‚úÖ Dados salvos no arquivo local com sucesso');
        
    } catch (error) {
        console.log('‚ùå Erro ao salvar dados no arquivo:', error.message);
    }
}

// Conectar ao Supabase ao iniciar o servidor
conectarSupabase();

// Configura√ß√µes de e-mail
const emailConfigs = {
    gmail: {
        host: 'smtp.gmail.com',
        port: 587,
        secure: false,
        auth: {
            user: 'jamarestudo@gmail.com', // E-mail que ENVIA as notifica√ß√µes
            pass: process.env.EMAIL_PASSWORD || 'mekz ihei gvuz fkgb'
        }
    }
};

// Fun√ß√£o para enviar e-mail
async function enviarEmail(destinatario, assunto, conteudo) {
    try {
        console.log('üìß Tentando enviar e-mail para:', destinatario);
        console.log('üîß Configura√ß√£o de e-mail:', {
            host: emailConfigs.gmail.host,
            port: emailConfigs.gmail.port,
            user: emailConfigs.gmail.auth.user,
            pass: process.env.EMAIL_PASSWORD ? '***CONFIGURADA***' : '***N√ÉO CONFIGURADA***'
        });
        
        // Verificar se a senha est√° configurada
        if (!process.env.EMAIL_PASSWORD || process.env.EMAIL_PASSWORD === 'sua_senha_aqui') {
            console.log('‚ùå Senha de e-mail n√£o configurada no Vercel');
            console.log('üí° Configure a vari√°vel EMAIL_PASSWORD no Vercel Dashboard');
            return false;
        }
        
        const transporter = nodemailer.createTransport(emailConfigs.gmail);
        
        console.log('üîç Verificando conex√£o com Gmail...');
        // Verificar conex√£o
        await transporter.verify();
        console.log('‚úÖ Conex√£o com Gmail verificada com sucesso');
        
        // Enviar e-mail
        console.log('üì§ Enviando e-mail...');
        const result = await transporter.sendMail({
            from: 'jamarestudo@gmail.com',
            to: destinatario,
            subject: assunto,
            html: conteudo
        });
        
        console.log('‚úÖ E-mail enviado com sucesso para:', destinatario);
        console.log('üìß Message ID:', result.messageId);
        return true;
    } catch (error) {
        console.log('‚ùå Erro ao enviar e-mail:', error.message);
        console.log('üîç C√≥digo do erro:', error.code);
        
        // Logs espec√≠ficos para debug
        if (error.code === 'EAUTH') {
            console.log('‚ùå Erro de autentica√ß√£o - verifique a senha do Gmail');
            console.log('üí° Certifique-se de usar uma senha de aplicativo, n√£o a senha normal');
        } else if (error.code === 'ECONNECTION') {
            console.log('‚ùå Erro de conex√£o com o servidor SMTP');
        } else if (error.code === 'ETIMEDOUT') {
            console.log('‚ùå Timeout na conex√£o com Gmail');
        } else if (error.code === 'EAUTHENTICATION') {
            console.log('‚ùå Falha na autentica√ß√£o - verifique as credenciais');
        }
        
        return false;
    }
}

// Sistema de notifica√ß√µes autom√°ticas
let emailConfigurado = null;
let ultimaNotificacao = {}; // Controlar para n√£o enviar repetidas

// Fun√ß√£o para verificar contas vencendo
async function verificarContasVencendo() {
    if (!emailConfigurado) {
        console.log('üìß E-mail n√£o configurado - pulando verifica√ß√£o');
        return;
    }
    
    const hoje = new Date();
    const proximos3Dias = new Date();
    proximos3Dias.setDate(hoje.getDate() + 3);
    
    const contasVencendo = contas.filter(conta => {
        if (conta.paga) return false;
        
        const dataVencimento = new Date(conta.dataVencimento);
        return dataVencimento >= hoje && dataVencimento <= proximos3Dias;
    });
    
    const contasVencidas = contas.filter(conta => {
        if (conta.paga) return false;
        
        const dataVencimento = new Date(conta.dataVencimento);
        return dataVencimento < hoje;
    });
    
    // Verificar se j√° enviamos notifica√ß√£o hoje
    const hojeStr = hoje.toDateString();
    const ultimaVencendo = ultimaNotificacao.vencendo || '';
    const ultimaVencidas = ultimaNotificacao.vencidas || '';
    
    // Enviar alerta de contas vencendo (m√°ximo 1x por dia)
    if (contasVencendo.length > 0 && ultimaVencendo !== hojeStr) {
        const assunto = '‚ö†Ô∏è Contas Vencendo - Sistema Fam√≠lia Jamar';
        const conteudo = `
            <h2>‚ö†Ô∏è Contas Vencendo nos Pr√≥ximos 3 Dias</h2>
            <p>Ol√°! Voc√™ tem contas vencendo em breve:</p>
            <br>
            <ul>
                ${contasVencendo.map(conta => `
                    <li><strong>${conta.descricao}</strong> - R$ ${conta.valor} - Vence: ${new Date(conta.dataVencimento).toLocaleDateString('pt-BR')}</li>
                `).join('')}
            </ul>
            <br>
            <p>üí∞ Total: R$ ${contasVencendo.reduce((sum, conta) => sum + parseFloat(conta.valor), 0).toFixed(2)}</p>
            <br>
            <p>üì± Sistema Fam√≠lia Jamar</p>
        `;
        
        await enviarEmail(emailConfigurado, assunto, conteudo);
        ultimaNotificacao.vencendo = hojeStr;
        console.log('üìß Alerta de contas vencendo enviado');
    }
    
    // Enviar alerta de contas vencidas (m√°ximo 1x por dia)
    if (contasVencidas.length > 0 && ultimaVencidas !== hojeStr) {
        const assunto = 'üö® Contas Vencidas - Sistema Fam√≠lia Jamar';
        const conteudo = `
            <h2>üö® Contas Vencidas</h2>
            <p>Ol√°! Voc√™ tem contas em atraso:</p>
            <br>
            <ul>
                ${contasVencidas.map(conta => `
                    <li><strong>${conta.descricao}</strong> - R$ ${conta.valor} - Venceu: ${new Date(conta.dataVencimento).toLocaleDateString('pt-BR')}</li>
                `).join('')}
            </ul>
            <br>
            <p>üí∞ Total: R$ ${contasVencidas.reduce((sum, conta) => sum + parseFloat(conta.valor), 0).toFixed(2)}</p>
            <br>
            <p>üì± Sistema Fam√≠lia Jamar</p>
        `;
        
        await enviarEmail(emailConfigurado, assunto, conteudo);
        ultimaNotificacao.vencidas = hojeStr;
        console.log('üìß Alerta de contas vencidas enviado');
    }
}

// Verificar contas a cada 6 horas (produ√ß√£o)
setInterval(verificarContasVencendo, 6 * 60 * 60 * 1000);

// Verificar contas a cada 2 horas (para teste mais frequente)
setInterval(verificarContasVencendo, 2 * 60 * 60 * 1000);

// WebSocket connections
io.on('connection', (socket) => {
    console.log('üîå Cliente conectado:', socket.id);
    console.log('üìä Total de clientes conectados:', io.engine.clientsCount);
    
    // Enviar dados atuais para o cliente
    socket.emit('contas_loaded', contas);
    console.log('üìã Dados enviados para cliente:', contas.length, 'contas');
    
    // Enviar status da conex√£o
    socket.emit('connection_status', {
        connected: isConnected,
        database: isConnected ? 'Supabase' : 'Local',
        totalContas: contas.length
    });
    
    socket.on('disconnect', (reason) => {
        console.log('üîå Cliente desconectado:', socket.id, 'Raz√£o:', reason);
        console.log('üìä Total de clientes conectados:', io.engine.clientsCount);
    });
    
    socket.on('error', (error) => {
        console.log('‚ùå Erro no WebSocket:', socket.id, error);
    });
    
    // Ping para manter conex√£o ativa
    socket.on('ping', () => {
        socket.emit('pong');
    });
});

// Fun√ß√£o para notificar todos os clientes
function notificarClientes(evento, dados) {
    try {
        console.log(`üì° Notificando clientes: ${evento}`, dados);
        io.emit(evento, dados);
        console.log(`‚úÖ Notifica√ß√£o enviada para ${io.engine.clientsCount} clientes`);
    } catch (error) {
        console.log('‚ùå Erro ao notificar clientes:', error.message);
    }
}

// Rotas da API
app.get('/api/contas', (req, res) => {
    console.log('üìã GET /api/contas - Solicitado');
    console.log('üìä Total de contas na mem√≥ria:', contas.length);
    console.log('üïê Timestamp da requisi√ß√£o:', new Date().toISOString());
    console.log('üîó Status da conex√£o:', isConnected ? 'Supabase' : 'Local');
    
    // Log detalhado das contas sendo enviadas
    if (contas.length > 0) {
        console.log('üìã Contas sendo enviadas:');
        contas.forEach((conta, index) => {
            console.log(`  ${index + 1}. ID: ${conta.id}, Descri√ß√£o: ${conta.descricao}, Tipo: ${conta.tipo}, Paga: ${conta.paga}`);
        });
    }
    
    res.json({
        contas: contas,
        status: {
            connected: isConnected,
            database: isConnected ? 'Supabase' : 'Local',
            totalContas: contas.length,
            timestamp: new Date().toISOString()
        }
    });
});

app.post('/api/contas', async (req, res) => {
    try {
        console.log('‚ûï POST /api/contas - Nova conta sendo adicionada');
        console.log('üìù Dados recebidos:', req.body);
        console.log('üÜî Pr√≥ximo ID a ser usado:', nextId);
        console.log('üîó Status da conex√£o:', isConnected ? 'Supabase' : 'Local');
        
        // Valida√ß√£o dos dados
        if (!req.body.descricao || !req.body.valor || !req.body.dataVencimento) {
            console.log('‚ùå Dados inv√°lidos recebidos');
            return res.status(400).json({ error: 'Dados obrigat√≥rios n√£o fornecidos' });
        }
        
        const novaConta = {
            id: nextId++,
            descricao: req.body.descricao.trim(),
            valor: parseFloat(req.body.valor).toFixed(2),
            dataVencimento: req.body.dataVencimento,
            categoria: req.body.categoria || 'Outros',
            tipo: req.body.tipo || 'conta', // 'conta' ou 'receita'
            recorrente: req.body.recorrente || false,
            paga: false,
            dataCriacao: new Date().toISOString()
        };
        
        console.log('üìã Nova conta criada:', novaConta);
        
        // Adicionar √† lista local
        contas.push(novaConta);
        console.log('üìä Total de contas ap√≥s adicionar:', contas.length);
        
        // Salvar no banco de dados
        if (supabase && isConnected) {
            console.log('üíæ Salvando no Supabase...');
            const { error } = await supabase
                .from('contas')
                .insert(novaConta);
                
            if (error) {
                console.log('‚ùå Erro ao salvar no Supabase:', error);
                throw error;
            }
            console.log('‚úÖ Conta salva no Supabase');
        } else {
            console.log('üíæ Salvando no arquivo local...');
            await salvarDadosLocal();
            console.log('‚úÖ Conta salva no arquivo local');
        }
        
        // Atualizar pr√≥ximo ID
        await salvarDados();
        
        // Notificar todos os clientes via WebSocket
        notificarClientes('conta_added', novaConta);
        
        console.log('‚úÖ Conta salva e notifica√ß√£o enviada');
        
        res.json({
            success: true,
            conta: novaConta,
            status: {
                connected: isConnected,
                database: isConnected ? 'Supabase' : 'Local',
                totalContas: contas.length
            }
        });
    } catch (error) {
        console.log('‚ùå Erro ao adicionar conta:', error.message);
        console.log('üîç Stack trace:', error.stack);
        res.status(500).json({ 
            error: 'Erro interno do servidor',
            details: error.message 
        });
    }
});

app.put('/api/contas/:id', async (req, res) => {
    try {
        const id = parseInt(req.params.id);
        console.log('‚úèÔ∏è PUT /api/contas/:id - Editando conta ID:', id);
        console.log('üìù Dados recebidos:', req.body);
        
        const index = contas.findIndex(conta => conta.id === id);
        
        if (index !== -1) {
            const contaAtualizada = { ...contas[index], ...req.body };
            contas[index] = contaAtualizada;
            
            console.log('üìã Conta atualizada:', contaAtualizada);
            
            // Salvar no banco de dados
            if (supabase && isConnected) {
                console.log('üíæ Salvando no Supabase...');
                const { error } = await supabase
                    .from('contas')
                    .update(req.body)
                    .eq('id', id);
                    
                if (error) {
                    throw error;
                }
                console.log('‚úÖ Conta atualizada no Supabase');
            } else {
                console.log('üíæ Salvando no arquivo local...');
                await salvarDadosLocal();
                console.log('‚úÖ Conta atualizada no arquivo local');
            }
            
            // Notificar todos os clientes via WebSocket
            notificarClientes('conta_updated', contaAtualizada);
            
            res.json({
                success: true,
                conta: contaAtualizada,
                status: {
                    connected: isConnected,
                    database: isConnected ? 'Supabase' : 'Local'
                }
            });
        } else {
            console.log('‚ùå Conta n√£o encontrada:', id);
            res.status(404).json({ error: 'Conta n√£o encontrada' });
        }
    } catch (error) {
        console.log('‚ùå Erro ao editar conta:', error.message);
        res.status(500).json({ 
            error: 'Erro interno do servidor',
            details: error.message 
        });
    }
});

app.delete('/api/contas/:id', async (req, res) => {
    try {
        const id = parseInt(req.params.id);
        console.log('üóëÔ∏è DELETE /api/contas/:id - Deletando conta ID:', id);
        
        const index = contas.findIndex(conta => conta.id === id);
        
        if (index !== -1) {
            const contaRemovida = contas[index];
            contas.splice(index, 1);
            
            console.log('üìã Conta removida:', contaRemovida);
            console.log('üìä Total de contas ap√≥s remo√ß√£o:', contas.length);
            
            // Salvar no banco de dados
            if (supabase && isConnected) {
                console.log('üíæ Removendo do Supabase...');
                const { error } = await supabase
                    .from('contas')
                    .delete()
                    .eq('id', id);
                    
                if (error) {
                    throw error;
                }
                console.log('‚úÖ Conta removida do Supabase');
            } else {
                console.log('üíæ Salvando no arquivo local...');
                await salvarDadosLocal();
                console.log('‚úÖ Conta removida do arquivo local');
            }
            
            // Notificar todos os clientes via WebSocket
            notificarClientes('conta_deleted', { id: id });
            
            res.json({ 
                success: true,
                message: 'Conta deletada com sucesso',
                status: {
                    connected: isConnected,
                    database: isConnected ? 'Supabase' : 'Local',
                    totalContas: contas.length
                }
            });
        } else {
            console.log('‚ùå Conta n√£o encontrada:', id);
            res.status(404).json({ error: 'Conta n√£o encontrada' });
        }
    } catch (error) {
        console.log('‚ùå Erro ao deletar conta:', error.message);
        res.status(500).json({ 
            error: 'Erro interno do servidor',
            details: error.message 
        });
    }
});

app.patch('/api/contas/:id/pagar', async (req, res) => {
    try {
        const id = parseInt(req.params.id);
        console.log('üí≥ PATCH /api/contas/:id/pagar - Marcando conta como paga ID:', id);
        
        const conta = contas.find(c => c.id === id);
        
        if (conta) {
            conta.paga = true;
            conta.dataPagamento = new Date().toISOString();
            
            console.log('üìã Conta marcada como paga:', conta);
            
            // Salvar no banco de dados
            if (supabase && isConnected) {
                console.log('üíæ Salvando no Supabase...');
                const { error } = await supabase
                    .from('contas')
                    .update({ paga: true, dataPagamento: conta.dataPagamento })
                    .eq('id', id);
                    
                if (error) {
                    throw error;
                }
                console.log('‚úÖ Conta atualizada no Supabase');
            } else {
                console.log('üíæ Salvando no arquivo local...');
                await salvarDadosLocal();
                console.log('‚úÖ Conta atualizada no arquivo local');
            }
            
            // Notificar todos os clientes via WebSocket
            notificarClientes('conta_paid', conta);
            
            res.json({
                success: true,
                conta: conta,
                status: {
                    connected: isConnected,
                    database: isConnected ? 'Supabase' : 'Local'
                }
            });
        } else {
            console.log('‚ùå Conta n√£o encontrada:', id);
            res.status(404).json({ error: 'Conta n√£o encontrada' });
        }
    } catch (error) {
        console.log('‚ùå Erro ao marcar conta como paga:', error.message);
        res.status(500).json({ 
            error: 'Erro interno do servidor',
            details: error.message 
        });
    }
});

// Rota para enviar e-mail
app.post('/api/enviar-email', async (req, res) => {
    const { destinatario, assunto, conteudo } = req.body;
    
    try {
        const sucesso = await enviarEmail(destinatario, assunto, conteudo);
        if (sucesso) {
            res.json({ message: 'E-mail enviado com sucesso' });
        } else {
            res.status(500).json({ error: 'Erro ao enviar e-mail' });
        }
    } catch (error) {
        res.status(500).json({ error: 'Erro interno do servidor' });
    }
});

// Rota para configurar e-mail
app.post('/api/configurar-email', async (req, res) => {
    console.log('üìß Rota /api/configurar-email chamada');
    console.log('üì® Dados recebidos:', req.body);
    
    const { email } = req.body;
    
    if (!email) {
        console.log('‚ùå E-mail n√£o fornecido');
        return res.status(400).json({ 
            success: false, 
            error: 'E-mail √© obrigat√≥rio' 
        });
    }
    
    try {
        console.log('üìß Tentando configurar e-mail para:', email);
        
        // Verificar se a senha est√° configurada
        if (!process.env.EMAIL_PASSWORD || process.env.EMAIL_PASSWORD === 'sua_senha_aqui') {
            console.log('‚ùå Senha de e-mail n√£o configurada no Vercel');
            console.log('üîç EMAIL_PASSWORD:', process.env.EMAIL_PASSWORD ? '***CONFIGURADA***' : '***N√ÉO CONFIGURADA***');
            return res.status(500).json({ 
                success: false, 
                error: 'Senha de e-mail n√£o configurada no servidor. Configure a vari√°vel EMAIL_PASSWORD no Vercel.' 
            });
        }
        
        // Enviar e-mail de confirma√ß√£o
        const assunto = '‚úÖ E-mail Configurado - Sistema Fam√≠lia Jamar';
        const conteudo = `
            <h2>‚úÖ E-mail configurado com sucesso!</h2>
            <p>Ol√°! Seu e-mail foi configurado no Sistema Fam√≠lia Jamar.</p>
            <p>A partir de agora voc√™ receber√° notifica√ß√µes sobre suas contas neste e-mail.</p>
            <br>
            <p><strong>E-mail configurado:</strong> ${email}</p>
            <br>
            <p>üì± Sistema Fam√≠lia Jamar</p>
        `;
        
        console.log('üì§ Enviando e-mail de confirma√ß√£o...');
        const sucesso = await enviarEmail(email, assunto, conteudo);
        
        if (sucesso) {
            console.log('‚úÖ E-mail de confirma√ß√£o enviado com sucesso');
            emailConfigurado = email; // Atualiza a configura√ß√£o do e-mail
            
            // Enviar relat√≥rio completo de todas as contas
            if (contas.length > 0) {
                console.log('üìä Enviando relat√≥rio completo de contas...');
                await enviarRelatorioCompleto(email);
            }
            
            res.json({ 
                success: true, 
                message: 'E-mail configurado com sucesso! Verifique sua caixa de entrada para o relat√≥rio completo.' 
            });
        } else {
            console.log('‚ùå Falha ao enviar e-mail de confirma√ß√£o');
            res.status(500).json({ 
                success: false, 
                error: 'Erro ao enviar e-mail de confirma√ß√£o. Verifique a configura√ß√£o do servidor.' 
            });
        }
    } catch (error) {
        console.log('‚ùå Erro interno na rota configurar-email:', error.message);
        console.log('üîç Stack trace:', error.stack);
        res.status(500).json({ 
            success: false, 
            error: 'Erro interno do servidor: ' + error.message 
        });
    }
});

// Fun√ß√£o para enviar relat√≥rio completo de contas
async function enviarRelatorioCompleto(email) {
    try {
        const hoje = new Date();
        
        // Separar contas por status
        const contasPagas = contas.filter(conta => conta.paga);
        const contasPendentes = contas.filter(conta => 
            !conta.paga && new Date(conta.dataVencimento) >= hoje
        );
        const contasVencidas = contas.filter(conta => 
            !conta.paga && new Date(conta.dataVencimento) < hoje
        );
        
        // Calcular totais
        const totalPendente = contasPendentes.reduce((sum, conta) => 
            sum + parseFloat(conta.valor), 0
        );
        const totalVencido = contasVencidas.reduce((sum, conta) => 
            sum + parseFloat(conta.valor), 0
        );
        const totalPago = contasPagas.reduce((sum, conta) => 
            sum + parseFloat(conta.valor), 0
        );
        
        const assunto = 'üìä Relat√≥rio Completo - Sistema Fam√≠lia Jamar';
        const conteudo = `
            <h2>üìä Relat√≥rio Completo de Contas</h2>
            <p>Ol√°! Aqui est√° o relat√≥rio completo de todas as suas contas:</p>
            <br>
            
            <h3>üìà Resumo Geral</h3>
            <ul>
                <li><strong>Total de contas:</strong> ${contas.length}</li>
                <li><strong>Contas pagas:</strong> ${contasPagas.length}</li>
                <li><strong>Contas pendentes:</strong> ${contasPendentes.length}</li>
                <li><strong>Contas vencidas:</strong> ${contasVencidas.length}</li>
            </ul>
            <br>
            
            <h3>üí∞ Valores</h3>
            <ul>
                <li><strong>Total pago:</strong> R$ ${totalPago.toFixed(2)}</li>
                <li><strong>Total pendente:</strong> R$ ${totalPendente.toFixed(2)}</li>
                <li><strong>Total vencido:</strong> R$ ${totalVencido.toFixed(2)}</li>
            </ul>
            <br>
            
            ${contasPendentes.length > 0 ? `
            <h3>‚è∞ Contas Pendentes</h3>
            <ul>
                ${contasPendentes.map(conta => `
                    <li><strong>${conta.descricao}</strong> - R$ ${conta.valor} - Vence: ${new Date(conta.dataVencimento).toLocaleDateString('pt-BR')} - ${conta.categoria}</li>
                `).join('')}
            </ul>
            <br>
            ` : ''}
            
            ${contasVencidas.length > 0 ? `
            <h3>üö® Contas Vencidas</h3>
            <ul>
                ${contasVencidas.map(conta => `
                    <li><strong>${conta.descricao}</strong> - R$ ${conta.valor} - Venceu: ${new Date(conta.dataVencimento).toLocaleDateString('pt-BR')} - ${conta.categoria}</li>
                `).join('')}
            </ul>
            <br>
            ` : ''}
            
            ${contasPagas.length > 0 ? `
            <h3>‚úÖ Contas Pagas</h3>
            <ul>
                ${contasPagas.map(conta => `
                    <li><strong>${conta.descricao}</strong> - R$ ${conta.valor} - Paga em: ${conta.dataPagamento ? new Date(conta.dataPagamento).toLocaleDateString('pt-BR') : 'Data n√£o registrada'} - ${conta.categoria}</li>
                `).join('')}
            </ul>
            <br>
            ` : ''}
            
            <p><strong>üìÖ Data do relat√≥rio:</strong> ${hoje.toLocaleDateString('pt-BR')} √†s ${hoje.toLocaleTimeString('pt-BR')}</p>
            <br>
            <p>üì± Sistema Fam√≠lia Jamar</p>
        `;
        
        await enviarEmail(email, assunto, conteudo);
        console.log('üìä Relat√≥rio completo enviado com sucesso');
        
    } catch (error) {
        console.log('‚ùå Erro ao enviar relat√≥rio completo:', error.message);
    }
}

// Rota para estat√≠sticas
app.get('/api/estatisticas', (req, res) => {
    const hoje = new Date();
    const contasVencidas = contas.filter(conta => 
        !conta.paga && new Date(conta.dataVencimento) < hoje
    );
    const contasPendentes = contas.filter(conta => 
        !conta.paga && new Date(conta.dataVencimento) >= hoje
    );
    const contasPagas = contas.filter(conta => conta.paga);
    
    const totalPendente = contasPendentes.reduce((sum, conta) => 
        sum + parseFloat(conta.valor), 0
    );
    const totalVencido = contasVencidas.reduce((sum, conta) => 
        sum + parseFloat(conta.valor), 0
    );
    
    res.json({
        total: contas.length,
        pendentes: contasPendentes.length,
        vencidas: contasVencidas.length,
        pagas: contasPagas.length,
        totalPendente: totalPendente.toFixed(2),
        totalVencido: totalVencido.toFixed(2)
    });
});

// Rota para testar notifica√ß√µes
app.post('/api/testar-notificacoes', async (req, res) => {
    console.log('üß™ Testando notifica√ß√µes...');
    
    if (!emailConfigurado) {
        return res.status(400).json({ 
            success: false, 
            error: 'E-mail n√£o configurado. Configure um e-mail primeiro.' 
        });
    }
    
    try {
        // Criar uma conta de teste
        const contaTeste = {
            id: nextId++,
            descricao: 'Conta de Teste - Luz',
            valor: '150.00',
            dataVencimento: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 dias
            categoria: 'Energia',
            recorrente: false,
            paga: false,
            dataCriacao: new Date().toISOString()
        };
        
        contas.push(contaTeste);
        
        // Executar verifica√ß√£o manual
        await verificarContasVencendo();
        
        res.json({ 
            success: true, 
            message: 'Notifica√ß√£o de teste enviada! Verifique sua caixa de entrada.',
            contaTeste: contaTeste
        });
    } catch (error) {
        console.log('‚ùå Erro ao testar notifica√ß√µes:', error.message);
        res.status(500).json({ 
            success: false, 
            error: 'Erro ao testar notifica√ß√µes: ' + error.message 
        });
    }
});


// Rota para testar e-mail (simples)
app.post('/api/testar-email', async (req, res) => {
    const { email } = req.body;
    
    if (!email) {
        return res.status(400).json({ 
            success: false, 
            error: 'E-mail √© obrigat√≥rio' 
        });
    }
    
    try {
        // Verificar se a senha est√° configurada
        if (!process.env.EMAIL_PASSWORD || process.env.EMAIL_PASSWORD === 'sua_senha_aqui') {
            return res.status(500).json({ 
                success: false, 
                error: 'Senha de e-mail n√£o configurada no servidor. Configure a vari√°vel EMAIL_PASSWORD no Vercel.' 
            });
        }
        
        const assunto = '‚úÖ E-mail Configurado - Sistema Fam√≠lia Jamar';
        const conteudo = `
            <h2>‚úÖ E-mail configurado com sucesso!</h2>
            <p>Ol√°! Seu e-mail foi configurado no Sistema Fam√≠lia Jamar.</p>
            <p>A partir de agora voc√™ receber√° notifica√ß√µes sobre suas contas neste e-mail.</p>
            <br>
            <p><strong>E-mail configurado:</strong> ${email}</p>
            <br>
            <p>üì± Sistema Fam√≠lia Jamar</p>
        `;
        
        const sucesso = await enviarEmail(email, assunto, conteudo);
        
        if (sucesso) {
            res.json({ 
                success: true, 
                message: 'E-mail de teste enviado com sucesso! Verifique sua caixa de entrada.' 
            });
        } else {
            res.status(500).json({ 
                success: false, 
                error: 'Erro ao enviar e-mail de teste. Verifique a configura√ß√£o do servidor.' 
            });
        }
    } catch (error) {
        res.status(500).json({ 
            success: false, 
            error: 'Erro interno do servidor: ' + error.message 
        });
    }
});

// Rota principal - redirecionar para o sistema com login
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index-wix.html'));
});

// Iniciar servidor
server.listen(PORT, () => {
    console.log(`üöÄ Servidor rodando na porta ${PORT}`);
    console.log(`üì± Sistema Fam√≠lia Jamar online!`);
    console.log(`üåê Acesse: http://localhost:${PORT}`);
    console.log(`üîå WebSockets ativos para atualiza√ß√£o autom√°tica`);
});

module.exports = app; 